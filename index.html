<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TS Angel Gold Master</title>
  <style>
    body { margin:0; font-family:Arial; background:#000; color:#0ff; }
    #controls { padding:10px; background:#111; display:flex; justify-content:space-between; align-items:center; }
    #signalBox { padding:10px; font-size:16px; white-space:pre-line; }
    button { padding:8px 16px; margin:5px; border:none; border-radius:6px; background:#0ff; color:#000; cursor:pointer; }
    button:disabled { background:#555; color:#aaa; cursor:not-allowed; }
    iframe { width:100%; height:400px; border:0; }
  </style>
</head>
<body>
  <div id="controls">
    <div>
      <select id="pairSelect">
        <option value="XAUUSD">XAUUSD (Gold)</option>
      </select>
      <select id="modeSelect">
        <option value="OFF">OFF</option>
        <option value="AUTO">AUTO</option>
      </select>
    </div>
    <button id="manualBtn">Manual Trade</button>
  </div>
  <iframe id="tvChart"></iframe>
  <div id="signalBox">üîÑ Waiting for signal...</div>

<script>
/* ================= CONFIG ================= */
const CONFIG = {
  "XAUUSD": {
    tv: "OANDA:XAUUSD",
    digits: 2,
    maxTradesPerSession: 2,
    maxTradesPerDay: 4,
    minTradesPerDay: 1,
    earlyEntryPips: 3,
    earlyEntryPercent: 0.1,
    pivot: 2000,
    zones: (p)=>[p-5,p,p+5]
  }
};

let activeSignal = null;
let tradeStats = { total:0, perSession:{}, perPair:{}, date:"" };
let pendingTimer = null;
let autoMonitorId = null;
const signalBox = document.getElementById("signalBox");
const pairSelect = document.getElementById("pairSelect");
const modeSelect = document.getElementById("modeSelect");
const tvChart = document.getElementById("tvChart");

/* ================= CHART LOAD ================= */
function loadChart(){
  const tv = CONFIG["XAUUSD"].tv;
  tvChart.src = `https://s.tradingview.com/widgetembed/?frameElementId=tvChart&symbol=${encodeURIComponent(tv)}&interval=5&theme=dark&style=1&timezone=Asia/Kolkata&withdateranges=1&studies=[]&toolbarbg=rgba(0,0,0,1)&hide_side_toolbar=0&allow_symbol_change=0&saveimage=1&details=1&hotlist=0&calendar=0`;
}
loadChart();

/* ================= HELPERS ================= */
function fmt(n,d=2){ return Number(n).toFixed(d) }
function renderSignalUpper(text){ signalBox.innerHTML = String(text).toUpperCase().replace(/\n/g,"<br>") }
function getISTDateString(d){ return d.toISOString().split('T')[0]; }
function getSessionName(date){ const h=date.getUTCHours()+5.5; if(h<9) return "ASIA"; if(h<16) return "LONDON"; return "NEWYORK"; }

/* ================= FETCH LIVE PRICE ================= */
async function fetchLivePrice(pair){
  try {
    const r = await fetch(`https://api.goldapi.io/v1/XAU/USD`, { headers:{ "x-access-token":"goldapi-yourkey" }});
    const j = await r.json();
    return parseFloat(j.price);  // ensure exact live price
  } catch(e){
    console.log("Price fetch error", e);
    return null;
  }
}

/* ================= STRATEGY ================= */
// Simplified OB + FVG detection
function detectOBFVG(prices){
  // prices = last candles array (mock for now)
  let last = prices[prices.length-1];
  let prev = prices[prices.length-2];
  let signal = { ob:false, fvg:false };
  if(last.low > prev.high) signal.fvg=true;   // simple FVG up
  if(last.high < prev.low) signal.fvg=true;   // simple FVG down
  if(prev.close < prev.open && last.close > last.open) signal.ob=true; // bullish OB
  if(prev.close > prev.open && last.close < last.open) signal.ob=true; // bearish OB
  return signal;
}

function getSetup(pair,price){
  const cfg = CONFIG[pair];
  let direction = price > cfg.pivot ? "BUY":"SELL";

  // mock RSI for demo
  let rsi = (price % 100)/2; 
  if(direction==="BUY" && rsi<50) direction=""; 
  if(direction==="SELL" && rsi>50) direction=""; 

  let obfvg = detectOBFVG([{open:price-2,close:price-1,high:price,low:price-3},{open:price,close:price+1,high:price+2,low:price-1}]);

  if(direction && (obfvg.ob||obfvg.fvg)){
    return {
      inZone:true,
      direction,
      entry:price,
      sl: direction==="BUY" ? price-20 : price+20,
      tp1: direction==="BUY" ? price+20 : price-20,
      tp2: direction==="BUY" ? price+40 : price-40,
      tp3: direction==="BUY" ? price+60 : price-60
    };
  }
  return { inZone:false };
}

/* ================= EXECUTION ================= */
function executeAndRecord(pair, setup, price, mode="AUTO"){
  if(activeSignal) return;
  activeSignal = {
    pair, direction: setup.direction, entry: price,
    tp1: setup.tp1, tp2: setup.tp2, tp3: setup.tp3,
    sl: setup.sl, mode, status:"RUNNING", time:new Date().toLocaleTimeString("en-IN",{hour12:true})
  };
  renderSignalUpper(`üìä ${pair}: ${setup.direction}
üü° ENTRY: ${fmt(price)}
üéØ TP1: ${fmt(setup.tp1)} | TP2: ${fmt(setup.tp2)} | TP3: ${fmt(setup.tp3)}
üõë SL: ${fmt(setup.sl)}
‚öôÔ∏è MODE: ${mode}`);
}

/* ================= AUTO MONITOR ================= */
async function autoMonitorTick(){
  if(activeSignal) return;
  const price = await fetchLivePrice("XAUUSD");
  if(!price) return;
  const setup = getSetup("XAUUSD", price);
  if(setup.inZone){
    executeAndRecord("XAUUSD", setup, price, "AUTO");
  } else {
    renderSignalUpper(`üõ∞Ô∏è AUTO MONITORING ACTIVE\nNO VALID SETUP\nLIVE PRICE: ${fmt(price)}`);
  }
}

/* ================= MODE SWITCH ================= */
modeSelect.addEventListener("change", ()=>{
  if(autoMonitorId){ clearInterval(autoMonitorId); autoMonitorId=null; }
  if(modeSelect.value==="AUTO"){
    renderSignalUpper("üõ∞Ô∏è AUTO MODE ON ‚Äî MONITORING...");
    autoMonitorId = setInterval(autoMonitorTick, 60_000);
  } else {
    renderSignalUpper("üî¥ AUTO OFF");
  }
});

/* ================= MANUAL TRADE ================= */
document.getElementById("manualBtn").addEventListener("click", async ()=>{
  const price = await fetchLivePrice("XAUUSD");
  if(!price) return;
  const setup = getSetup("XAUUSD", price);
  if(setup.inZone) executeAndRecord("XAUUSD", setup, price, "MANUAL");
  else renderSignalUpper("‚ùå NO VALID MANUAL SETUP NOW.");
});
</script>
</body>
</html>
